#!/bin/bash
source ../common
GROUP_TITLE="Normal POR Test"
PARAM_FILE=parameter
SEED=1
TITLE='OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH'
NLBS=16
TEST_WINDOW_PERCENT=5
AMOUNT_WR_PERCENT=1
AMOUNT_RD_PERCENT=100
IODEPTH_RD=32
IODEPTH_WR=32
IODEPTH_MAX=128

group_init $@

run_config
#IOSIZE_WR=$NAMESPACE_BSZ
IOSIZE_WR=128K
IOSIZE_RD=128K

#echo "namespace_bsz    : $NAMESPACE_BSZ"
#echo "namespace_size   : $NAMESPACE_SIZE"
#echo "namspacee_size_gb: $NAMESPACE_SIZE_GB"
#echo "IOSIZE_WR         : $IOSIZE_WR" 
#echo "IOSIZE_RD         : $IOSIZE_RD" 

#sequential write and verify
for SLBA_WR in seq uniform
do
	for ((START_PERCENT=0;START_PERCENT<100;START_PERCENT+=TEST_WINDOW_PERCENT))
	do
		END_PERCENT=$((START_PERCENT+TEST_WINDOW_PERCENT))
		if [ $END_PERCENT -gt 100 ]
		then
				break;
		fi

		# write
		OPERATION=write
		LBA_RANGE="$START_PERCENT%:$TEST_WINDOW_PERCENT%"
		AMOUNT="BYTE:$AMOUNT_WR_PERCENT%"
		SLBA=$SLBA_WR
		IOSIZE=$IOSIZE_WR
		IODEPTH=$IODEPTH_WR
		OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH SEED=$SEED run_test

		# power off and on
		power_off
		power_on
		enable_spdk

		# read (verify)
		OPERATION=read
		AMOUNT="BYTE:$AMOUNT_RD_PERCENT%"
		SLBA=seq
		IOSIZE=$IOSIZE_RD
		IODEPTH=$IODEPTH_RD
		OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH SEED=$SEED run_test
	done	
done

# Read (verify) entire capacity
OPERATION=read
LBA_RANGE="0%:100%"
AMOUNT="BYTE:100%"
SLBA=seq
IOSIZE=$IOSIZE_RD
IODEPTH=$IODEPTH_MAX

OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH SEED=$SEED run_test
