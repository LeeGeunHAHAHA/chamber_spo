#!/bin/bash
source ../common
GROUP_TITLE="Sudden POR Test - Level 3"
PARAM_FILE=parameter
SEED=1
TITLE='OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH'
NLBS=16
TEST_WINDOW_PERCENT=100
AMOUNT_WR_PERCENT=10
AMOUNT_RD_PERCENT=10
IODEPTH_RD=32
IODEPTH_WR=128
SPOR_LEVEL_RD=0
SPOR_LEVEL_WR=3
USER_DATA_FLUSH_TIME=5

group_init $@

run_config
#IOSIZE_WR=$NAMESPACE_BSZ
IOSIZE_WR=16K
IOSIZE_RD=128K

#echo "namespace_bsz    : $NAMESPACE_BSZ"
#echo "namespace_size   : $NAMESPACE_SIZE"
#echo "namspacee_size_gb: $NAMESPACE_SIZE_GB"
#echo "IOSIZE_WR         : $IOSIZE_WR" 
#echo "IOSIZE_RD         : $IOSIZE_RD" 

#sequential write and verify
#for SLBA_WR in seq uniform
for ((i=1;i<=100;i++))
do
	echo 
	echo "Test [$i/100]"
	for SLBA_WR in uniform
	do
		for ((START_PERCENT=0;START_PERCENT<100;START_PERCENT+=TEST_WINDOW_PERCENT))
		do
			END_PERCENT=$((START_PERCENT+TEST_WINDOW_PERCENT))
			if [ $END_PERCENT -gt 100 ]
			then
					break;
			fi
	
			# write
			OPERATION=write
			LBA_RANGE="$START_PERCENT%:$TEST_WINDOW_PERCENT%"
			AMOUNT_WR_PERCENT=$((1 + $RANDOM % 10))
			AMOUNT="BYTE:$AMOUNT_WR_PERCENT%"
			SLBA=$SLBA_WR
			IOSIZE=$IOSIZE_WR
			IODEPTH=$IODEPTH_WR
			SPOR_LEVEL=$SPOR_LEVEL_WR
			OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH SPOR_LEVEL=$SPOR_LEVEL SEED=$SEED run_test
	
			#echo "Wait for $USER_DATA_FLUSH_TIME seconds in order to flush user data to NAND Flash"
			#sleep $USER_DATA_FLUSH_TIME
	
			# power off and on
			power_off_post_process
#			read
			power_on
#			read
			enable_spdk
#			read
	
			# read (verify)
			OPERATION=read
			AMOUNT="BYTE:$AMOUNT_RD_PERCENT%"
			SLBA=uniform
			IOSIZE=$IOSIZE_RD
			IODEPTH=$IODEPTH_RD
			SPOR_LEVEL=$SPOR_LEVEL_RD
			OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH SPOR_LEVEL=$SPOR_LEVEL SEED=$SEED run_test
		done	
	done
done

OPERATION=read
LBA_RANGE="0%:100%"
AMOUNT="BYTE:100%"
SLBA=seq
IOSIZE=$IOSIZE_RD
IODEPTH=$IODEPTH_RD
SPOR_LEVEL=$SPOR_LEVEL_RD
OPERATION=$OPERATION LBA_RANGE=$LBA_RANGE AMOUNT=$AMOUNT SLBA=$SLBA IOSIZE=$IOSIZE IODEPTH=$IODEPTH SPOR_LEVEL=$SPORL_LEVEL SEED=$SEED run_test
