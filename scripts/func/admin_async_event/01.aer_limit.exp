#!/usr/bin/env bash
source ../common > /dev/null 2>&1

init

# this test case is valid only for SPDK
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
nvme admin-passthru $FQA_DEVICE --opcode=0xc &
check_aerc
command error: SC 5 SCT 1
NVMe Status:ASYNC_LIMIT: The number of concurrently outstanding Asynchronous Event Request commands has been exceeded(105) Command Result:00000000

# enable all asynchronous events
nvme set-feature $FQA_DEVICE -f 11 -v 0xffff
set-feature:0b (Async Event Configuration), value:0x00ffff

# clear error status event
nvme error-log $FQA_DEVICE > /dev/null
check_aerc

# namespace management command

# insufficient nvm capacity error, aerc will arrive
nvme create-ns $FQA_DEVICE -s 0x1000000000 -c 0x1000000000 -f 2
command error: SC 15 SCT 1
NVMe Status:NS_INSUFFICIENT_CAPACITY: Creating the namespace requires more free space than is currently available. The Command Specific Information field of the Error Information Log specifies the total amount of NVM capacity required to create the namespace in bytes(115)
check_aerc
Asynchronous Event Type: Error Status(0)
Asynchronous Event Info: Transient Internal Error(4)

nvme admin-passthru $FQA_DEVICE --opcode=0xc &
check_aerc
command error: SC 5 SCT 1
NVMe Status:ASYNC_LIMIT: The number of concurrently outstanding Asynchronous Event Request commands has been exceeded(105) Command Result:00000000

pkill -9 -P $$
