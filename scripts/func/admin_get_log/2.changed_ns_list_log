#!/usr/bin/env bash
source ../common > /dev/null 2>&1

# test setup
rescan-ns

nvme id-ctrl $FQA_DEVICE -H | grep "Namespace Attribute"

# disable aer
nvme set-feature $FQA_DEVICE -f 0xb -v 0

nvme delete-ns $FQA_DEVICE -n 0xFFFFFFFF
nvme changed-ns-list-log $FQA_DEVICE > /dev/null

rescan-ns

# disable aer
nvme set-feature $FQA_DEVICE -f 0xb -v 0

for i in $(seq 1 $MAX_NS); do
  nvme create-ns $FQA_DEVICE -s 0x1000 -c 0x1000 -f 2 -d 0 -m 0
  nvme attach-ns $FQA_DEVICE -n $i -c $CTRL_ID
done

#  namespaces from 1 to $MAX_NS
nvme changed-ns-list-log $FQA_DEVICE

# nothing
nvme changed-ns-list-log $FQA_DEVICE

# enable aer
nvme set-feature $FQA_DEVICE -f 0xb -v 0xfff

# 1. format a namespace
rescan-ns
nvme format $FQA_DEVICE -n 1 -l 0

check_aerc

# namespace 1 changed
nvme changed-ns-list-log $FQA_DEVICE

# nothing
nvme changed-ns-list-log $FQA_DEVICE

# 2. format all namespaces
rescan-ns
nvme format $FQA_DEVICE -n 0xFFFFFFFF -l 1

check_aerc

# all namespaces changed
nvme changed-ns-list-log $FQA_DEVICE

# nothing
nvme changed-ns-list-log $FQA_DEVICE

# 3. delete a namespace
rescan-ns
nvme delete-ns $FQA_DEVICE -n 1

check_aerc

# namespace 1 changed
nvme changed-ns-list-log $FQA_DEVICE

# nothing
nvme changed-ns-list-log $FQA_DEVICE

# 4. delete all namespaces
rescan-ns
nvme delete-ns $FQA_DEVICE -n 0xFFFFFFFF

check_aerc

# namespaces from 2 to 128 changed
nvme changed-ns-list-log $FQA_DEVICE

# nothing
nvme changed-ns-list-log $FQA_DEVICE

rescan-ns
