#!/usr/bin/env bash
source ../common > /dev/null 2>&1

function write()
{
    # $1 control and length
    # $2 reference tag
    # $3 application tag and mask

    echo "1234" | nvme io-passthru $FQA_DEVICE -n 1 -w -l 4 -o 1 -6 $1 -8 $2 -9 $3
}

function write_meta()
{
    # $1 control and length
    # $2 reference tag
    # $3 application tag and mask

    printf "123400\xab\xcd0000" | nvme io-passthru $FQA_DEVICE -n 1 -w -l 4 -m 8 -o 1 -6 $1 -8 $2 -9 $3
}

# initialize
nvme delete-ns $FQA_DEVICE -n 0xFFFFFFFF
delete-ns: Success, deleted nsid:-1

nvme create-ns $FQA_DEVICE -c 0x100000 -s 0x100000 -f 0
create-ns: Success, created nsid:1
nvme attach-ns $FQA_DEVICE -n 1 - c $CTRL_ID
attach-ns: Success, nsid:1

# no metadata
nvme format $FQA_DEVICE -n 1 -l 0
Success formatting namespace:1
nvme id-ns $FQA_DEVICE -n 1 | grep -e 'flbas' -e 'in use' -e 'dps'
flbas   : 0
dps     : 0
lbaf  0 : ms:0   lbads:9  rp:0x2 (in use)

rescan-ns

# enable PRINFO
write 0x3c000000 0 0xabcdffff
NVMe command result:00000000
write 0x38000000 0 0xabcdffff
NVMe command result:00000000
write 0x34000000 0 0xabcdffff
NVMe command result:00000000
write 0x30000000 0 0xabcdffff
NVMe command result:00000000
write 0x2c000000 0 0xabcdffff
NVMe command result:00000000
write 0x28000000 0 0xabcdffff
NVMe command result:00000000
write 0x24000000 0 0xabcdffff
NVMe command result:00000000
write 0x20000000 0 0xabcdffff
NVMe command result:00000000
write 0x1c000000 0 0xabcdffff
NVMe command result:00000000
write 0x18000000 0 0xabcdffff
NVMe command result:00000000
write 0x14000000 0 0xabcdffff
NVMe command result:00000000
write 0x10000000 0 0xabcdffff
NVMe command result:00000000
write 0x0c000000 0 0xabcdffff
NVMe command result:00000000
write 0x08000000 0 0xabcdffff
NVMe command result:00000000
write 0x04000000 0 0xabcdffff
NVMe command result:00000000
write 0x00000000 0 0xabcdffff
NVMe command result:00000000

# separate buffer, PI type 1
nvme format $FQA_DEVICE -n 1 -l 1 -i 1
Success formatting namespace:1
nvme id-ns $FQA_DEVICE -n 1 | grep -e 'flbas' -e 'in use' -e 'dps'
flbas   : 0x1
dps     : 0x1
lbaf  1 : ms:8   lbads:9  rp:0x3 (in use)

rescan-ns

# pract=1b, prchk=???b, success
write 0x3c000000 0 0xabcdffff
NVMe command result:00000000
write 0x38000000 0 0xabcdffff
NVMe command result:00000000
write 0x34000000 0 0xabcdffff
NVMe command result:00000000
write 0x30000000 0 0xabcdffff
NVMe command result:00000000
write 0x2c000000 0 0xabcdffff
NVMe command result:00000000
write 0x28000000 0 0xabcdffff
NVMe command result:00000000
write 0x24000000 0 0xabcdffff
NVMe command result:00000000
write 0x20000000 0 0xabcdffff
NVMe command result:00000000

# pract=0b, prchk=???b, error
write 0x1c000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x18000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x14000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x10000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x0c000000 0 0xabcdffff
command error: SC 83 SCT 2
NVMe Status:APPTAG_CHECK: The command was aborted due to an end-to-end application tag check failure(283) Command Result:00000000
write 0x08000000 0 0xabcdffff
command error: SC 83 SCT 2
NVMe Status:APPTAG_CHECK: The command was aborted due to an end-to-end application tag check failure(283) Command Result:00000000

# success
write 0x04000000 0 0xabcdffff
NVMe command result:00000000
write 0x00000000 0 0xabcdffff
NVMe command result:00000000

# invalid protection information(181h)
write 0x3c000000 1 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000

# separate buffer, PI type 2
nvme format $FQA_DEVICE -n 1 -l 1 -i 2
Success formatting namespace:1
nvme id-ns $FQA_DEVICE -n 1 | grep -e 'flbas' -e 'in use' -e 'dps'
flbas   : 0x1
dps     : 0x2
lbaf  1 : ms:8   lbads:9  rp:0x3 (in use)

rescan-ns

# pract=1b, prchk=???b, success
write 0x3c000000 0 0xabcdffff
NVMe command result:00000000
write 0x38000000 0 0xabcdffff
NVMe command result:00000000
write 0x34000000 0 0xabcdffff
NVMe command result:00000000
write 0x30000000 0 0xabcdffff
NVMe command result:00000000
write 0x2c000000 0 0xabcdffff
NVMe command result:00000000
write 0x28000000 0 0xabcdffff
NVMe command result:00000000
write 0x24000000 0 0xabcdffff
NVMe command result:00000000
write 0x20000000 0 0xabcdffff
NVMe command result:00000000

# pract=0b, prchk=???b, error
write 0x1c000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x18000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x14000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x10000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x0c000000 0 0xabcdffff
command error: SC 83 SCT 2
NVMe Status:APPTAG_CHECK: The command was aborted due to an end-to-end application tag check failure(283) Command Result:00000000
write 0x08000000 0 0xabcdffff
command error: SC 83 SCT 2
NVMe Status:APPTAG_CHECK: The command was aborted due to an end-to-end application tag check failure(283) Command Result:00000000

# success
write 0x04000000 0 0xabcdffff
NVMe command result:00000000
write 0x00000000 0 0xabcdffff
NVMe command result:00000000

# reftag test, error
write 0x04000000 1 0xabcdffff
command error: SC 84 SCT 2
NVMe Status:REFTAG_CHECK: The command was aborted due to an end-to-end reference tag check failure(284) Command Result:00000000

# separate buffer, PI type 3
nvme format $FQA_DEVICE -n 1 -l 1 -i 3
Success formatting namespace:1
nvme id-ns $FQA_DEVICE -n 1 | grep -e 'flbas' -e 'in use' -e 'dps'
flbas   : 0x1
dps     : 0x3
lbaf  1 : ms:8   lbads:9  rp:0x3 (in use)

rescan-ns

# pract=1b, prchk=??0b, success
write 0x38000000 0 0xabcdffff
NVMe command result:00000000
write 0x30000000 0 0xabcdffff
NVMe command result:00000000
write 0x28000000 0 0xabcdffff
NVMe command result:00000000
write 0x20000000 0 0xabcdffff
NVMe command result:00000000
# pract=1b, prchk=??1b, error
write 0x3c000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000
write 0x34000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000
write 0x2c000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000
write 0x24000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000

# pract=0b, prchk=???b, error
write 0x1c000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000
write 0x18000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x14000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000
write 0x10000000 0 0xabcdffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write 0x0c000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000
write 0x08000000 0 0xabcdffff
command error: SC 83 SCT 2
NVMe Status:APPTAG_CHECK: The command was aborted due to an end-to-end application tag check failure(283) Command Result:00000000
write 0x04000000 0 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000

# success
write 0x00000000 0 0xabcdffff
NVMe command result:00000000

# reftag test, error
write 0x04000000 1 0xabcdffff
command error: SC 81 SCT 1
NVMe Status:Unknown(181) Command Result:00000000

# separate buffer, PI type 1, 64B meta(first 8byte)
nvme format $FQA_DEVICE -n 1 -l 4 -i 1 -p 0
Success formatting namespace:1
nvme id-ns $FQA_DEVICE -n 1 | grep -e 'flbas' -e 'in use' -e 'dps'
flbas   : 0x4
dps     : 0x1
lbaf  4 : ms:64  lbads:12 rp:0x1 (in use)

rescan-ns

write_meta 0x1c000000 0 0xcdabffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write_meta 0x0c000000 0 0xcdabffff
command error: SC 83 SCT 2
NVMe Status:APPTAG_CHECK: The command was aborted due to an end-to-end application tag check failure(283) Command Result:00000000

# separate buffer, PI type 1, 64B meta(last 8byte)
nvme format $FQA_DEVICE -n 1 -l 4 -i 1 -p 1
Success formatting namespace:1
nvme id-ns $FQA_DEVICE -n 1 | grep -e 'flbas' -e 'in use' -e 'dps'
flbas   : 0x4
dps     : 0x9
lbaf  4 : ms:64  lbads:12 rp:0x1 (in use)

rescan-ns

write_meta 0x1c000000 0 0xcdabffff
command error: SC 82 SCT 2
NVMe Status:GUARD_CHECK: The command was aborted due to an end-to-end guard check failure(282) Command Result:00000000
write_meta 0x0c000000 0 0xcdabffff
command error: SC 83 SCT 2
NVMe Status:APPTAG_CHECK: The command was aborted due to an end-to-end application tag check failure(283) Command Result:00000000
